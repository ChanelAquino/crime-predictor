---
title: "Analysis of Crime Data from 2010 to Present to Predict Crime Committed"
author: "Chanel Aquino, Dario Molina, Evert Rodriguez"
date: "May 7, 2018"
output: html_document
---

```{r global_options, message=FALSE, warning=FALSE, include=FALSE, fig.align = "center"}
knitr::opts_chunk$set(prompt=TRUE, comment="", echo=T)
```

## Introduction / Objective
In this project, we will utilize, visualize, and analyze data from the [Crime Data from 2010 to Present](https://data.lacity.org/A-Safe-City/Crime-Data-from-2010-to-Present/y8tr-7khq) dataset. The dataset reflects incidents of crime in the City of Los Angeles dating back to 2010. Before any preprocessing, there are approximately 1.73 million rows and 26 columns in the dataset; each row represents a crime incident.  

After some initial data observation, we will finally create some classification learning models to predict what crime will be committed given certain predictors.

## Data 
```{r}
library(rpart)
library(rpart.plot)
library(maptree)
library(caret)
source("https://raw.githubusercontent.com/grbruns/cst383/master/lin-regr-util.R")
source("https://raw.githubusercontent.com/grbruns/cst383/master/class-util.R")
crimes = read.csv('~/crime-predictor/crimes.csv', na.strings=c('NA', 'N/A', '<NA>'))
names(crimes) = tolower(names(crimes))
```

## Preprocessing / Cleaning
The following is a table of columns that were removed from the dataset and the reasons why they were removed.  

column removed      | description of column                 | reason for removing
------------------  | ------------------------------------- | -----------------------
dr.number           | the division records number           | merely uniquely IDs each row; does not provide valuable information
area.id             | ID of community police station        | will use __area.name__ column for area 
reporting.district  | 4-digit code that represents a sub-area within a Geographic Area | will use __location__ column for locating crimes
mo.code             | modus operandi: activities associated with the suspect in commission of the crime | would be time consuming to translate these to their descriptions
crime.code          | indicates the crime committed         | will use __crime.code.description__ to describe crime committed
crime.code.1        | same as crime.code                    | (same as above)
crime.code.2        | code for any additional crime         | crime codes 2, 3, and 4 are respectively less serious offenses
crime.code.3        | code for any additional crime         | (same as above)
crime.code.4        | code for any additional crime         | (same as above)
premise.code        | code for the type of structure, vehicle, or location where the crime took place | will use __premise.description__ to describe premise
weapon.used.code    | code for the type of weapon used      | will use __weapon.description__ to describe weapon
status.code         | status of the case                    | status of the case irrelevant to predicting crime committed
status.description  | defines the status code provided      | (same as above)
address             | street address of crime incident rounded to the nearest hundred block to maintain anonymity | will use __location__ column for locating crimes
cross.street        | cross street of rounded address       | (same as above)
```{r}
crimes[['dr.number']] = NULL
crimes[['area.id']] = NULL
crimes[['reporting.district']] = NULL
crimes[['mo.codes']] = NULL
crimes[['crime.code']] = NULL
crimes[['crime.code.1']] = NULL
crimes[['crime.code.2']] = NULL
crimes[['crime.code.3']] = NULL
crimes[['crime.code.4']] = NULL
crimes[['premise.code']] = NULL
crimes[['weapon.used.code']] = NULL
crimes[['status.code']] = NULL
crimes[['status.description']] = NULL
crimes[['address']] = NULL
crimes[['cross.street']] = NULL
```

## Missing Data
After removing unneeded columns, we calculated the percentages of NA values in each column in the dataset. (If there are no NA values in the column, this information was not displayed.) 8% of the rows in the dataset did not have values for the __victim.age__ column. These rows were omitted from the dataset.
```{r}
pct.na = apply(crimes, 2, function(x) round(mean(is.na(x)) * 100, 3))
pct.na = pct.na[pct.na > 0] 
data.frame(pct.na)
crimes = na.omit(crimes)
```

## Preprocessing (continued): month, day, year, and hour
Here, __month__, __day__, __year__, and __hour__ columns were created after being derived from the __date.occurred__ and __time.occurred__ columns. These new columns represent the date and time that the crime occurred. Finally, crimes that occurred during the years 2010 - 2013 (inclusive) will be removed from the dataset, resulting in a dataset with crimes occurring in the past 5 years only.
```{r}
crimes$month = as.numeric(substr(crimes$date.occurred,1,2))
crimes$day = as.numeric(substr(crimes$date.occurred,4,5))
crimes$year = as.numeric(substr(crimes$date.occurred,7,10))
years = c(2014:2018)
crimes = crimes[crimes$year %in% years,]

crimes$hour = NA
rows = which(nchar(crimes$time.occurred) == 1)
crimes$hour[rows] = 0

rows = which(nchar(crimes$time.occurred) == 2)
crimes$hour[rows] = 0

rows = which(nchar(crimes$time.occurred) == 3)
crimes$hour[rows] = as.numeric(substr(crimes$time.occurred[rows],1,1))

rows = which(nchar(crimes$time.occurred) == 4)
crimes$hour[rows] = as.numeric(substr(crimes$time.occurred[rows],1,2))

crimes[['date.reported']] = NULL
crimes[['date.occurred']] = NULL
crimes[['time.occurred']] = NULL
```

## Preprocessing (continued): Categorizing crime.code.description, weapon.code.description, and victim.descent
Currently, there are 143 unique values in the __crime.code.description__. In an effort to simplify classification, values in this column will be categorized into 1 of 4 groups: i) violent crime, ii) property crime, iii) consensual crime, and iv) other (which contains white-collar crimes, organized crimes, and consensual crimes. Descriptions and examples of these different types of crime can be found in the online text, [Social Problems: Continuity and Change](https://saylordotorg.github.io/text_social-problems-continuity-and-change/s11-02-types-of-crime.html). It is important to note that we lose some valuable information when condensing 143 crime descriptions into 4 categories.
```{r}
crimes$crime.code.description = tolower(crimes$crime.code.description)
crimes$crime.type = NA

# violent crime
patterns = c('assault', 'neglect', 'firearms', 'rape', 'sex', 'abuse', 
             'shots', 'bomb', 'kidnap', 'lynch', 'battery', 'reckless driving',
             'abandonement', 'drugs', 'manslaughter', 'trafficking', 'abortion',
             'weapon', 'cruelty', 'child', 'false imprisonment', 'threats', 'chld',
             'homicide', 'oral copulation', 'incest', 'firearms restraining order' )
crimes$crime.type[grepl(paste(patterns, collapse = "|"), crimes$crime.code.description)] = "violent"

# property crime
patterns = c('burglary', 'theft', 'shoplifting', 'stolen', 'arson', 
             'vandalism', 'defrauding innkeeper', 'disrupt school',
             'pickpocket', 'train wrecking', 'robbery', 'theft of identity',
             'tresspassing', 'document forgery / stolen felony', 'rob', 'prowler',
             'stalking', 'peeping tom', 'unauthorized computer access',
             'disturbing the peace', 'failure to disperse', 'fraud',
             'throwing object at moving vehicle', 'property', 'snatching', 'till tap')
crimes$crime.type[grepl(paste(patterns, collapse = "|"), crimes$crime.code.description)] = "property"


# consensual crime
patterns = c('pimping', 'resisting', 'indecent exposure', 'contempt of court',
             'violation of temporary restraining order', 'failure to yield',
             'violation of restraining order', 'driving without owner consent', 'document worthless',
             'bribery', 'pandering', 'extortion', 'counterfeit')
crimes$crime.type[grepl(paste(patterns, collapse = "|"), crimes$crime.code.description)] = "consensual"

# other crime
crimes$crime.type[is.na(crimes$crime.type)] = "other"

crimes$crime.type = factor(crimes$crime.type)
crimes[['crime.code.description']] = NULL
```

Similary, the 79 unique values in the __weapon.description__ column were used to create a new column, __weapon.type__ that contains 1 of 4 values: i) projectile, ii) edged, iii) impact, and iv) other (which includes chemical weapons and weapons of mass destruction). Details on these types of weapons can be found on the [Black Belt](https://blackbeltmag.com/martial-arts-weapons/5-categories-of-modern-weapons-how-to-incorporate-them-into-your-reality-based-self-defense-training/) website. Again, it is important to note that we lose some valuable information when condensing 79 weapon descriptions into 4 categories.
```{r}
crimes$weapon.description = tolower(crimes$weapon.description)
crimes$weapon.type = NA

# projectile weapons
patterns = c('bottle', 'pistol', 'gun', 'revolver', 'rifle',
             'bow and arrow', 'semiautomatic assault', 'firearm',
             'rock', 'thrown')
crimes$weapon.type[grepl(paste(patterns, collapse = "|"), crimes$weapon.description)] = "projectile"

# edged weapons
patterns = c('knife', 'screwdriver', 'switchblade', 'cutting', 
             'dagger', 'razor', 'glass', 'ice pick', 'machete',
             'sword', 'cleaver', 'scissors', 'axe')
crimes$weapon.type[grepl(paste(patterns, collapse = "|"), crimes$weapon.description)] = "edged"

# impact weapons
patterns = c('belt flailing instrument/chain', 'hammer', 'club/bat', 
             'martial arts weapons', 'brass knuckles', 'syringe', 'rope', 
             'strong-arm', 'stick', 'pipe', 'board', 'fixed object',
             'concrete block', 'tire iron', 'blackjack')
crimes$weapon.type[grepl(paste(patterns, collapse = "|"), crimes$weapon.description)] = "impact"

# other weapons
crimes$weapon.type[is.na(crimes$weapon.type)] = "other"

crimes$weapon.type = factor(crimes$weapon.type)
crimes[['weapon.description']] = NULL
```

Finally, the __victim.descent__ column was altered to contain the following values: asian, black, hispanic/latin, american indian/native, pacific islander, white, other/unknown. The __victim.sex__ column was also altered to contain the following values: male, female, and other/unknown.
```{r}
crimes$victim.descent = tolower(crimes$victim.descent)
crimes$victim.descent[crimes$victim.descent == 'a'] = 'asian'
crimes$victim.descent[crimes$victim.descent == 'c'] = 'asian'
crimes$victim.descent[crimes$victim.descent == 'd'] = 'asian'
crimes$victim.descent[crimes$victim.descent == 'f'] = 'asian'
crimes$victim.descent[crimes$victim.descent == 'j'] = 'asian'
crimes$victim.descent[crimes$victim.descent == 'k'] = 'asian'
crimes$victim.descent[crimes$victim.descent == 'l'] = 'asian'
crimes$victim.descent[crimes$victim.descent == 'v'] = 'asian'
crimes$victim.descent[crimes$victim.descent == 'z'] = 'asian'

crimes$victim.descent[crimes$victim.descent == 'b'] = 'black'

crimes$victim.descent[crimes$victim.descent == 'h'] = 'hispanic/latin'

crimes$victim.descent[crimes$victim.descent == 'i'] = 'american indian/native'

crimes$victim.descent[crimes$victim.descent == 'g'] = 'pacific islander'
crimes$victim.descent[crimes$victim.descent == 'p'] = 'pacific islander'
crimes$victim.descent[crimes$victim.descent == 's'] = 'pacific islander'
crimes$victim.descent[crimes$victim.descent == 'u'] = 'pacific islander'

crimes$victim.descent[crimes$victim.descent == 'w'] = 'white'

crimes$victim.descent[crimes$victim.descent == 'o'] = 'other/unknown'
crimes$victim.descent[crimes$victim.descent == ''] = 'other/unknown'
crimes$victim.descent[crimes$victim.descent == 'x'] = 'other/unknown'

crimes$victim.descent = factor(crimes$victim.descent)

crimes$victim.sex = tolower(crimes$victim.sex)
crimes$victim.sex[crimes$victim.sex == 'm'] = 'male'
crimes$victim.sex[crimes$victim.sex == 'f'] = 'female'
crimes$victim.sex[crimes$victim.sex == 'x'] = 'other/unknown'
crimes$victim.sex[crimes$victim.sex == 'h'] = 'other/unknown'
crimes$victim.sex[crimes$victim.sex == ''] = 'other/unknown'
crimes$victim.sex = factor(crimes$victim.sex)
```

## Data Exploration
```{r}
plot(density(crimes$victim.age), main='density of victim ages', xlab='age', col='red', las=1)
grid()
```

```{r}
par(mar=c(9,5,5,5))
boxplot(victim.age ~ victim.descent, data=crimes, main='victim ages and descent', las=2, ylab='age', col='red')
```

```{r}
barplot(table(crimes$hour), main='hour crime committed', xlab='hour', col='red', las=1)
```

## Training / Test Sets
```{r}
set.seed(123)
tr.rows = sample(1:nrow(crimes), .75*nrow(crimes))
tr.dat = crimes[tr.rows,]
te.dat = crimes[-tr.rows,]
```

## Classification Tree Model 1
```{r}
# TODO: dario + assessment
set.seed(132)
crimes.small = crimes[crimes$year %in% c(2018),]
split = split_data(crimes.small)
tr_dat = split[[1]]
te_dat = split[[2]]

treeFit = rpart(crime.type~ area.name + victim.sex + victim.age ,data=tr_dat, method="class")

prp(treeFit, extra=106, varlen=5,
 main="Classification for Crime Type",
 box.col=c("palegreen", "pink")[treeFit$frame$yval])
```

## Classification Tree Model 2
```{r}
# TODO: dario + assessment
```

## Naive Bayes Classification Model 1
```{r}
library(e1071)
  # TODO: evert + assessment
```

## Naive Bayes Classification Model 2
```{r}

```

## Conclusion
<!-- TODO: everyone -->